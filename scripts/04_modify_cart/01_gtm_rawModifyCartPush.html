<script>

    var oldCartItemsList = {{JS Utility - get cartItemsList from script in document}}(document);

    // push the initial state of the cart to dataLayer
    window.dataLayer.push({
        'event' : 'ssRawModifyCartPush',
        'ssRawModifyCart': { 
            'initialCartItemsList': oldCartItemsList 
        }
    });

    // initialize the DL variable we will use to identify the action taken when our tag fires
    // this variable will be set with 'add' or 'remove' whenever the 'ssRawModifyCartPush' DL Push event occurs
    window.dataLayer.push({
        'event' : 'initModifyCartTagInfo',
        'modifyCartTagInfo':{
            'action': 'not_set',
            'quantity': '0',
            'productName': 'not_set'
        }
    });

    // Select the node that will be observed for mutations
    // in this case it's the main Cart Page Container div
    var nodeToObserve = document.querySelector("div.CartPage-container-3tQnb");
    var subtotalPriceClassName = "CartTable-subtotalPrice-2JFeD";
    var emptyCartMessageClassName = "empty-message";
  
    if(nodeToObserve){
      
      var observerCallback = function(mutationsList, observer){

        for(var j=0; j < mutationsList.length; j++){
          
            // first check to see if any nodes were added and grab the classList of the proper element in the mutationObject
            var classListToSearch = (mutationsList[j].addedNodes.length === 0)
                                    ? mutationsList[j].target.parentElement.classList // if a node was not added use this
                                    : mutationsList[j].addedNodes[0].classList;       // if a node was added use this

          
            var cartChanged = false;

            // NOTE: since the classList is a DomTokenList, we can use the "contains" method          
            // If the classList contains "CartTable-subtotalPrice-2JFeD" then the SUBTOTAL CHANGED
            if(classListToSearch.contains(subtotalPriceClassName)){
                cartChanged = true;
            }
            // If the classList contains "empty-message" then the CART IS EMPTY
            else if(classListToSearch.contains(emptyCartMessageClassName)){
                cartChanged = true;
            }
          

            if(cartChanged){
                var httpRequest = new XMLHttpRequest();
                var cartURL = "https://cachetattoo.com/cart";
                
                httpRequest.open("GET", cartURL);
                httpRequest.send();

                // this event fires once the request is complete
                // more info found here: https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readyState
                httpRequest.onload = function(e){
          
//                    console.log("HTTP Request Finished");
          
                    var domParser = new DOMParser();

                    var httpResponse = domParser.parseFromString(httpRequest.responseText, "text/html");
              
                    var newCartItemsList = {{JS Utility - get cartItemsList from script in document}}(httpResponse);

                    // create the raw modified cart object
                    // "oldCartItemsList" is the snapshot with all relevant items in the previous version of the cart
                    // "newCartItemsList" is the snapshot with all relevant items in the updated version of the cart
                    // push these raw lists to dataLayer with an event key ("_gtm" tells us that it is coming from GTM)
                    window.dataLayer.push({
                        'event' : 'ssRawModifyCartPush',
                        'ssRawModifyCart': {
                            'oldCartItemsList': oldCartItemsList,
                            'newCartItemsList': newCartItemsList
                        }
                    });

                    // the above push will set the 'modifyActionType' DL variable
                    // so now we need another push action to trigger the actual Modify Cart tag
                    window.dataLayer.push({
                        'event' : 'fireModifyCartTag'
                    });

                    oldCartItemsList = newCartItemsList;
                };
            }
                    
        }
        
      }
      
      // create our observer and set it's callback to the function above
      var observer = new MutationObserver(observerCallback);
      
      // Options for the observer (which mutations to observe)
      var observerConfig = { childList: true, subtree: true, characterData: true };    
      
      // Start observing the target node for configured mutations
      observer.observe(nodeToObserve, observerConfig);
      
    }
  
</script>
